
UCLASS(Abstract)
class UCharacter_Boss_Summit_RubyKnight_Magic_SoundDef : USoundDefBase
{
	/* AUTO-GENERATED CODE - Anything from here to end should NOT be edited! */

	UFUNCTION(BlueprintEvent)
	void OnSingleSlashTelegraph(FSummitKnightPlayerParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnSingleSlashDirectHitBoth(){}

	UFUNCTION(BlueprintEvent)
	void OnSingleSlashDirectHit(FSummitKnightPlayerParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnSingleSlashNearHit(FSummitKnightPlayerParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnSingleSlashShockwaveHit(FSummitKnightPlayerParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnSingleSlashMiss(FSummitKnightPlayerParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnSingleSlashAborted(){}

	UFUNCTION(BlueprintEvent)
	void OnSpinningSlashStartLoop(){}

	UFUNCTION(BlueprintEvent)
	void OnSpinningSlashEnd(){}

	UFUNCTION(BlueprintEvent)
	void OnSpinningSlashAborted(){}

	UFUNCTION(BlueprintEvent)
	void OnCrystalBottomDeploy(FSummitKnightCrystalBottomParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnCrystalBottomRetract(FSummitKnightCrystalBottomParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnCrystalBottomShatter(FSummitKnightCrystalBottomParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnSwoopTelegraph(FSummitKnightPlayerParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnSwoopChargeStart(FSummitKnightPlayerParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnSwoopChargeEnd(){}

	UFUNCTION(BlueprintEvent)
	void OnSwoopHitPlayer(FSummitKnightPlayerParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnSwoopAggroTelegraph(FSummitKnightPlayerParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnSwoopAggroStart(FSummitKnightPlayerParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnSwoopAggroEnd(){}

	UFUNCTION(BlueprintEvent)
	void OnSwoopAggroHitPlayer(FSummitKnightPlayerParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnSlamTelegraph(){}

	UFUNCTION(BlueprintEvent)
	void OnSlamDirectHitBoth(){}

	UFUNCTION(BlueprintEvent)
	void OnSlamDirectHit(FSummitKnightPlayerParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnSlamShockwaveHit(FSummitKnightPlayerParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnSlamMiss(){}

	UFUNCTION(BlueprintEvent)
	void OnSlamImpact(FSummitKnightBladeImpactParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnSlamFreeSword(FSummitKnightBladeImpactParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnSlamAggroTelegraph(){}

	UFUNCTION(BlueprintEvent)
	void OnSlamAggroDirectHitBoth(){}

	UFUNCTION(BlueprintEvent)
	void OnSlamAggroDirectHit(FSummitKnightPlayerParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnSlamAggroMiss(){}

	UFUNCTION(BlueprintEvent)
	void OnSmashGroundAggroDirectHitBoth(){}

	UFUNCTION(BlueprintEvent)
	void OnSmashGroundAggroDirectHit(FSummitKnightPlayerParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnSmashGroundAggroNearHit(FSummitKnightPlayerParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnSmashGroundAggroMiss(){}

	UFUNCTION(BlueprintEvent)
	void OnSmashGroundAborted(){}

	UFUNCTION(BlueprintEvent)
	void OnStartCirlingAngry(){}

	UFUNCTION(BlueprintEvent)
	void OnAlmostDeadReaction(){}

	UFUNCTION(BlueprintEvent)
	void OnTelegraphLargeAreaStrike(){}

	UFUNCTION(BlueprintEvent)
	void OnLargeAreaStrikeStop(){}

	UFUNCTION(BlueprintEvent)
	void OnTelegraphHomingFireballs(FSummitKnightLaunchProjectileParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnStartLaunchingHomingFireballs(FSummitKnightLaunchProjectileParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnLaunchHomingFireball(FSummitKnightLaunchProjectileParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnStopLaunchingHomingFireballs(FSummitKnightLaunchProjectileParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnStopHomingFireballs(){}

	UFUNCTION(BlueprintEvent)
	void OnTelegraphTrackingFlames(){}

	UFUNCTION(BlueprintEvent)
	void OnStartLaunchingTrackingFlames(){}

	UFUNCTION(BlueprintEvent)
	void OnLaunchTrackingFlames(FSummitKnightTrackingFlamesParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnTelegraphSummonCritters(){}

	UFUNCTION(BlueprintEvent)
	void OnStartSummoningCritters(){}

	UFUNCTION(BlueprintEvent)
	void OnSummonCrittersBlobsLaunched(FSummitKnightLaunchCritterBlobsParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnSummonedCritterBlobImpact(FSummitKnightLaunchCritterBlobParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnSummonedCritterEmerge(FSummitKnightCritterEmergeParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnStopSummoningCritters(){}

	UFUNCTION(BlueprintEvent)
	void OnSingleSlashImpact(){}

	UFUNCTION(BlueprintEvent)
	void OnDualSlashFirstTelegraph(FSummitKnightPlayerParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnDualSlashSecondTelegraph(FSummitKnightPlayerParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnDualSlashFirstDirectHitBoth(){}

	UFUNCTION(BlueprintEvent)
	void OnDualSlashSecondDirectHitBoth(){}

	UFUNCTION(BlueprintEvent)
	void OnDualSlashFirstDirectHit(FSummitKnightPlayerParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnDualSlashSecondDirectHit(FSummitKnightPlayerParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnDualSlashFirstImpact(){}

	UFUNCTION(BlueprintEvent)
	void OnDualSlashSecondImpact(){}

	UFUNCTION(BlueprintEvent)
	void OnFireballImpact(FSummitKnightProjectileImpactParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnTrackingFlameImpact(FSummitKnightTrackingFlameImpactParams Params){}

	UFUNCTION(BlueprintEvent)
	void OnAllTrackingFlamesExpired(){}

	/* END OF AUTO-GENERATED CODE */

	private TMap<ASummitDragonSlayerAoePattern, UHazeAudioEmitter> ActiveLargeAreaStrikePatterns;

	UFUNCTION(NotBlueprintCallable)
	void OnLargeAreaStrikePatternStart(FSummitKnightLargeAreaStrikeParams Params)
	{
		UHazeAudioEmitter PatternEmitter = nullptr;
		int _ = 0;
		AudioEmitterRotationPool::GetNext(LargeAreaAttackEmitterPool, PatternEmitter, _, FVector());

		ActiveLargeAreaStrikePatterns.FindOrAdd(Params.Pattern, PatternEmitter);
		LargeAreaStrikePatternStart(PatternEmitter);
	}
	UFUNCTION(BlueprintEvent)
	void LargeAreaStrikePatternStart(UHazeAudioEmitter PatternEmitter) {}

	UFUNCTION(NotBlueprintCallable)
	void OnLargeAreaStrikePatternImpact(FSummitKnightLargeAreaStrikeParams Params)
	{
		UHazeAudioEmitter PatternEmitter;
		if(ActiveLargeAreaStrikePatterns.Find(Params.Pattern, PatternEmitter))
		{
			LargeAreaStrikePatternImpact(PatternEmitter);
		}

	}
	UFUNCTION(BlueprintEvent)
	void LargeAreaStrikePatternImpact(UHazeAudioEmitter PatternEmitter) {}

	UPROPERTY(NotVisible, BlueprintReadOnly)
	UHazeAudioEmitter FireballsEmitter;

	UPROPERTY(NotVisible, BlueprintReadOnly)
	UHazeAudioEmitter TrackingFlamesEmitter;

	UPROPERTY(BlueprintReadWrite)
	FHazeAudioEmitterRotationPool FireballsImpactEmitterPool;
	
	FHazeAudioEmitterRotationPool LargeAreaAttackEmitterPool;

	AAISummitKnight Knight;
	private TArray<FAkSoundPosition> FireballSoundPositions;
	private TArray<FAkSoundPosition> CrystalTrailsSoundPositions;

	bool GetActiveFireballs(TArray<AHazeActor>&out Fireballs, bool&out bIsHoming = false)
	{
		if(bIsPerformingHomingFireballAttack)
		{
			Fireballs = Knight.HomingFireballsLauncher.ActiveFireballs;
			bIsHoming = true;
			return true;
		}
		if(bIsPerformingAreaDenialFireballAttack)
		{
			Fireballs = Knight.AreaDenialFireballLauncher.ActiveFireballs;
			bIsHoming = false;
			return true;
		}

		return false;
	}

	bool GetbIsPerformingLargeAreaAttack() const property
	{
		return Knight.KnightComp.InitialAoeManager.bActive;
	}

	bool GetbIsPerformingHomingFireballAttack() const property
	{
		return Knight.HomingFireballsLauncher.ActiveFireballs.IsEmpty() == false;
	}

	bool GetbIsPerformingAreaDenialFireballAttack() const property
	{
		return Knight.AreaDenialFireballLauncher.ActiveFireballs.IsEmpty() == false;
	}

	bool GetbIsPerformingCrystalTrails() const property
	{
		return Knight.KnightComp.IsSpawningCrystalTrails();
	}

	UFUNCTION(BlueprintOverride)
	bool OverrideEmitterSceneAttachment(FName EmitterName, FName& ComponentName, AHazeActor& TargetActor,
										FName& BoneName, bool& bUseAttach)
	{
		TargetActor = HazeOwner;
		bUseAttach = (EmitterName == n"DefaultEmitter");
		return true;
	}

	UFUNCTION(BlueprintOverride)
	void ParentSetup()
	{
		Knight = Cast<AAISummitKnight>(HazeOwner);
		LargeAreaAttackEmitterPool = GetPooledEmitters(3, FOnInitRotationPoolComponent(this, n"InitializeLargeAreaAttackPooledEmitter"));
	}

	UFUNCTION(NotBlueprintCallable)
	void InitializeLargeAreaAttackPooledEmitter(UHazeAudioEmitter PooledEmitter)
	{
		PooledEmitter.SetAttenuationScaling(8000);
	}

	UFUNCTION(BlueprintOverride)
	void TickActive(float DeltaSeconds)
	{
		// Large Area Attack
		if(bIsPerformingLargeAreaAttack)
		{
			for(auto& Elem : ActiveLargeAreaStrikePatterns)		
			{
				ASummitDragonSlayerAoePattern Pattern = Elem.Key;
				UHazeAudioEmitter PatternEmitter = Elem.Value;

				TArray<FAkSoundPosition> PatternSoundPositions;
				PatternSoundPositions.SetNum(Pattern.Children.Num());

				for(int i = 0; i < Pattern.Children.Num(); ++i)
				{
					auto Child = Pattern.Children[i];
					PatternSoundPositions[i].SetPosition(Child.MovableComp.WorldLocation);
				}

				PatternEmitter.SetMultiplePositions(PatternSoundPositions);
			}
		}

		// Fireballs
		TArray<AHazeActor> ActiveFireballs;
		bool bIsHomingFireballs = false;
		if(GetActiveFireballs(ActiveFireballs, bIsHomingFireballs))
		{
			const int NumFireballs = ActiveFireballs.Num();
			if(NumFireballs > 0)
			{
				FireballSoundPositions.Empty();
				FireballSoundPositions.SetNum(NumFireballs);

				for(int i = 0; i < NumFireballs; ++i)
				{
					auto Fireball = ActiveFireballs[i];
					FireballSoundPositions[i].SetPosition(Fireball.ActorLocation);		
				}
			}			

			FireballsEmitter.SetMultiplePositions(FireballSoundPositions);
		}

		// Crystal Trails (TrackingFlames)
		if(bIsPerformingCrystalTrails)
		{
			const int NumTrails = Knight.KnightComp.ActiveCrystalTrails.Num();
			if(NumTrails > 0)
			{
				CrystalTrailsSoundPositions.Empty(NumTrails);
				CrystalTrailsSoundPositions.SetNum(NumTrails);

				for(int i = 0; i < NumTrails; ++i)
				{
					auto Trail = Knight.KnightComp.ActiveCrystalTrails[i];
					CrystalTrailsSoundPositions[i].SetPosition(Trail.ActorLocation);
				}

				TrackingFlamesEmitter.SetMultiplePositions(CrystalTrailsSoundPositions);
			}
		}
	}
}