class USkylineEnforcerPlayerInvulnerabilityCapability : UHazeCapability
{
	default CapabilityTags.Add(n"PlayerInvulnerability");

	UBasicAIHealthComponent HealthComp;
	USkylineEnforcerSettings Settings;

	default TickGroup = EHazeTickGroup::Gameplay;

	UFUNCTION(BlueprintOverride)
	void Setup()
	{
		HealthComp = UBasicAIHealthComponent::Get(Owner);
		Settings = USkylineEnforcerSettings::GetSettings(Owner);
	}

	UFUNCTION(BlueprintOverride)
	bool ShouldActivate() const
	{
		if (HealthComp.IsDead())
			return false;
		if (Owner.IsActorDisabled())
			return false;
		return true;
	}

	UFUNCTION(BlueprintOverride)
	bool ShouldDeactivate() const
	{
		if (HealthComp.IsDead())
			return true;
		if (Owner.IsActorDisabled())
			return true;
		return false;
	}

	UFUNCTION(BlueprintOverride)
	void OnActivated()
	{
		for (AHazePlayerCharacter Player : Game::Players)
		{
			UPlayerHealthSettings::SetInvulnerabilityDurationAfterTakingDamage(Player, Settings.PlayerInvulnerabilityDurationAfterDamage, this, EHazeSettingsPriority::Gameplay);
			UPlayerHealthSettings::SetSecondChanceWhenKilledDuration(Player, Settings.PlayerSecondChanceWhenKilledDuration, this, EHazeSettingsPriority::Gameplay);
		}
	}

	UFUNCTION(BlueprintOverride)
	void OnDeactivated()
	{
		for (AHazePlayerCharacter Player : Game::Players)
		{
			Player.ClearSettingsByInstigator(this);
		}
	}
};